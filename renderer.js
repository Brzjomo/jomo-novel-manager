const { ipcRenderer } = require('electron');

let currentView = 'list';
let currentFile = null;
let allFiles = [];
let searchTimeout = null;

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    // ÁõëÂê¨ÂàùÂßãËÆæÁΩÆ
    ipcRenderer.on('init-settings', (event, settings) => {
        // Â∫îÁî®‰∏ªÈ¢ò
        const themeLink = document.getElementById('theme-style');
        themeLink.href = `styles/${settings.theme || 'light'}.css`;
        // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
        loadFiles();
    });

    document.getElementById('settings').addEventListener('click', () => {
        ipcRenderer.send('show-settings');
    });

    document.getElementById('selectDir').addEventListener('click', () => {
        ipcRenderer.send('select-directory');
    });
    
    document.getElementById('toggleView').addEventListener('click', () => {
        currentView = currentView === 'list' ? 'tree' : 'list';
        loadFiles();
    });
    
    document.getElementById('download').addEventListener('click', () => {
        if (currentFile) {
            ipcRenderer.send('download-file', currentFile);
        }
    });
    
    document.getElementById('openFile').addEventListener('click', () => {
        if (currentFile) {
            ipcRenderer.send('open-file', currentFile);
        }
    });
    
    document.getElementById('showInFolder').addEventListener('click', () => {
        if (currentFile) {
            ipcRenderer.send('show-in-folder', currentFile);
        }
    });

    // Ê∑ªÂä†ÊãñÂä®Ë∞ÉÊï¥ÂäüËÉΩ
    const resizer = document.getElementById('resizer');
    const fileList = document.querySelector('.file-list');
    let isResizing = false;
    let lastWidth = localStorage.getItem('fileListWidth') || '30%';
    fileList.style.width = lastWidth;

    resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        
        // Èò≤Ê≠¢ÈÄâ‰∏≠ÊñáÊú¨
        document.addEventListener('selectstart', preventSelect);
    });

    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerWidth = document.querySelector('.container').offsetWidth;
        let newWidth = e.clientX;
        
        // Á°Æ‰øùÂÆΩÂ∫¶Âú®ÂÖÅËÆ∏ËåÉÂõ¥ÂÜÖ
        newWidth = Math.max(200, Math.min(newWidth, containerWidth * 0.5));
        
        // ËΩ¨Êç¢‰∏∫ÁôæÂàÜÊØî
        const widthPercent = (newWidth / containerWidth * 100) + '%';
        fileList.style.width = widthPercent;
        
        // ‰øùÂ≠òÂΩìÂâçÂÆΩÂ∫¶Âà∞ localStorage
        localStorage.setItem('fileListWidth', widthPercent);
    });

    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = 'default';
            document.removeEventListener('selectstart', preventSelect);
        }
    });

    // Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆ
    const settings = JSON.parse(localStorage.getItem('settings') || '{"theme":"light"}');
    const themeLink = document.getElementById('theme-style');
    themeLink.href = `styles/${settings.theme}.css`;

    // ÊêúÁ¥¢Ê°ÜÂäüËÉΩ
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');

    searchInput.addEventListener('input', (e) => {
        // ‰ΩøÁî®Èò≤ÊäñÂ§ÑÁêÜÊêúÁ¥¢
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase();
            filterAndDisplayFiles(searchTerm);
        }, 300);
    });

    clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        filterAndDisplayFiles('');
    });

    // ‰øÆÊîπÊñá‰ª∂ÂàóË°®Êé•Êî∂Â§ÑÁêÜ
    ipcRenderer.on('files-list', (event, files) => {
        allFiles = files; // ‰øùÂ≠òÊâÄÊúâÊñá‰ª∂
        const searchTerm = searchInput.value.toLowerCase();
        filterAndDisplayFiles(searchTerm);
    });

    function filterAndDisplayFiles(searchTerm) {
        const fileTree = document.getElementById('fileTree');
        fileTree.innerHTML = '';
        
        if (!searchTerm) {
            // Ê≤°ÊúâÊêúÁ¥¢ËØçÊó∂ÊòæÁ§∫ÊâÄÊúâÊñá‰ª∂
            if (currentView === 'list') {
                renderFileList(allFiles, fileTree);
            } else {
                renderFileTree(allFiles, fileTree);
            }
            return;
        }

        // Âú®ÂàóË°®ËßÜÂõæ‰∏≠ÊêúÁ¥¢
        if (currentView === 'list') {
            const filteredFiles = allFiles.filter(file => 
                file.name.toLowerCase().includes(searchTerm)
            );
            renderFileList(filteredFiles, fileTree);
        } else {
            // Âú®Ê†ëËßÜÂõæ‰∏≠ÊêúÁ¥¢
            const filteredFiles = filterTreeFiles(allFiles, searchTerm);
            renderFileTree(filteredFiles, fileTree);
        }
    }

    function filterTreeFiles(files, searchTerm) {
        return files.reduce((acc, file) => {
            if (file.type === 'directory') {
                const filteredChildren = filterTreeFiles(file.children || [], searchTerm);
                if (filteredChildren.length > 0) {
                    acc.push({
                        ...file,
                        children: filteredChildren
                    });
                }
            } else if (file.name.toLowerCase().includes(searchTerm)) {
                acc.push(file);
            }
            return acc;
        }, []);
    }

    // Ê∑ªÂä†ÊªöÂä®Âà∞È°∂ÈÉ®ÂäüËÉΩ
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const fileTree = document.getElementById('fileTree');

    // ÁõëÂê¨Êñá‰ª∂Ê†ëÁöÑÊªöÂä®‰∫ã‰ª∂
    fileTree.addEventListener('scroll', () => {
        // ÂΩìÊªöÂä®Ë∂ÖËøá300pxÊó∂ÊòæÁ§∫ÊåâÈíÆ
        if (fileTree.scrollTop > 280) {
            scrollTopBtn.style.display = 'flex';
        } else {
            scrollTopBtn.style.display = 'none';
        }
    });

    // ÁÇπÂáªÊåâÈíÆÊªöÂä®Âà∞È°∂ÈÉ®
    scrollTopBtn.addEventListener('click', () => {
        fileTree.scrollTo({
            top: 0,
            behavior: 'smooth'  // Âπ≥ÊªëÊªöÂä®
        });
    });

    ipcRenderer.on('app-version', (event, version) => {
        document.title = `JOMOÂ∞èËØ¥ÁÆ°ÁêÜÂ∑•ÂÖ∑ v${version}`;
    });
});

// ÈòªÊ≠¢ÊñáÊú¨ÈÄâÊã©
function preventSelect(e) {
    e.preventDefault();
    return false;
}

// Âä†ËΩΩÊñá‰ª∂ÂàóË°®
function loadFiles() {
    const lastWidth = localStorage.getItem('fileListWidth');
    if (lastWidth) {
        document.querySelector('.file-list').style.width = lastWidth;
    }
    ipcRenderer.send('get-files', currentView);
}

// Ê∑ªÂä†Êñ∞ÁöÑ IPC ÁõëÂê¨Âô®
ipcRenderer.on('directory-selected', (event, path) => {
    if (path) {
        currentNovelPath = path;
        loadFiles(); // ÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂ÂàóË°®
    }
});

// Êé•Êî∂Êñá‰ª∂ÂàóË°®
ipcRenderer.on('files-list', (event, files) => {
    const fileTree = document.getElementById('fileTree');
    fileTree.innerHTML = '';
    
    if (currentView === 'list') {
        renderFileList(files, fileTree);
    } else {
        renderFileTree(files, fileTree);
    }
});

// Ê∏≤ÊüìÊñá‰ª∂È¢ÑËßà
ipcRenderer.on('file-preview', (event, content) => {
    const previewElement = document.getElementById('preview');
    
    // Â¶ÇÊûúËøîÂõûÁöÑÊòØÈîôËØØÊ∂àÊÅØ‰∏îÂåÖÂê´Êñá‰ª∂‰∏çÂ≠òÂú®ÁöÑÊèêÁ§∫ÔºåÂà∑Êñ∞ÂàóË°®
    if (content.startsWith('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•Ôºö') && content.includes('ENOENT')) {
        loadFiles();
        previewElement.textContent = 'Êñá‰ª∂Â∑≤Ë¢´Âà†Èô§';
        return;
    }
    
    previewElement.textContent = content;
    // ÈáçÁΩÆÊªöÂä®‰ΩçÁΩÆÂà∞È°∂ÈÉ®
    previewElement.scrollTop = 0;
});

function renderFileList(files, container) {
    files.forEach(file => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.textContent = file.name.replace(/\.txt$/i, '');
        div.onclick = () => {
            // ÁßªÈô§ÂÖ∂‰ªñÊñá‰ª∂ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            container.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Ê∑ªÂä†ÂΩìÂâçÊñá‰ª∂ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            div.classList.add('selected');
            currentFile = file.path;
            ipcRenderer.send('preview-file', file.path);
        };
        container.appendChild(div);
    });
}

function renderFileTree(files, container) {
    files.forEach(file => {
        const div = document.createElement('div');
        
        if (file.type === 'directory') {
            const folderDiv = document.createElement('div');
            folderDiv.className = 'directory-item';
            folderDiv.style.marginLeft = '20px';
            
            // Ê∑ªÂä†ÊäòÂè†ÂõæÊ†áÂíåÊñá‰ª∂Â§πÂêçÁß∞
            const titleDiv = document.createElement('div');
            titleDiv.className = 'folder-title';
            titleDiv.innerHTML = `<span class="folder-icon">‚ñº</span> üìÅ ${file.name}`;
            folderDiv.appendChild(titleDiv);
            
            // ÂàõÂª∫Â≠êÊñá‰ª∂ÂÆπÂô®
            const childContainer = document.createElement('div');
            childContainer.className = 'folder-content';
            renderFileTree(file.children, childContainer);
            folderDiv.appendChild(childContainer);
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÊäòÂè†
            titleDiv.onclick = (e) => {
                e.stopPropagation();
                const icon = titleDiv.querySelector('.folder-icon');
                const content = titleDiv.parentElement.querySelector('.folder-content');
                
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    icon.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '‚ñ∂';
                }
            };
            
            div.appendChild(folderDiv);
        } else {
            div.className = 'file-item';
            div.style.marginLeft = '20px';
            div.textContent = `üìÑ ${file.name.replace(/\.txt$/i, '')}`;
            div.onclick = () => {
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                div.classList.add('selected');
                currentFile = file.path;
                ipcRenderer.send('preview-file', file.path);
            };
        }
        
        container.appendChild(div);
    });
}

// Ê∑ªÂä†‰∏ªÈ¢òÂàáÊç¢Â§ÑÁêÜ
ipcRenderer.on('theme-changed', (event, theme) => {
    const themeLink = document.getElementById('theme-style');
    themeLink.href = `styles/${theme}.css`;
});

// ÁõëÂê¨ËÆæÁΩÆÊõ¥Êñ∞
ipcRenderer.on('settings-updated', (event, settings) => {
    // Â¶ÇÊûúÂΩìÂâçÊúâÈ¢ÑËßàÁöÑÊñá‰ª∂ÔºåÂàôÈáçÊñ∞Âä†ËΩΩÈ¢ÑËßà
    if (currentFile) {
        ipcRenderer.send('preview-file', currentFile);
    }
});

// ÁõëÂê¨Êñá‰ª∂ÂèòÂä®
ipcRenderer.on('files-changed', () => {
    loadFiles();
});
